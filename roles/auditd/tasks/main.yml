---
- name: Install auditd package
  ansible.builtin.package:
    name: auditd
    state: present
  when: auditd_manage_packages | default(true)
  tags: [install, auditd]

- name: Render auditd.conf
  ansible.builtin.template:
    src: auditd.conf.j2
    dest: /etc/audit/auditd.conf
    owner: root
    group: root
    mode: '0644'
    backup: true
  notify: Restart auditd
  tags: [config, auditd]

- name: Render audit rules
  ansible.builtin.template:
    src: rules.j2
    dest: /etc/audit/rules.d/10-ansible-audit.rules
    owner: root
    group: root
    mode: '0644'
    backup: true
  notify: Reload audit rules
  tags: [rules, auditd]

- name: Render rsyslog imfile snippet for audit logs
  ansible.builtin.template:
    src: rsyslog_imfile.j2
    dest: "{{ auditd_rsyslog_conf_path }}"
    owner: root
    group: root
    mode: '0644'
    backup: true
  when: auditd_forward_method == 'rsyslog'
  notify: Restart rsyslog
  tags: [rsyslog, auditd]

# Fluent Bit setup when auditd_forward_method == 'fluentbit'
- name: Ensure Fluent Bit config directory exists
  ansible.builtin.file:
    path: "{{ auditd_fluentbit_conf_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: auditd_forward_method == 'fluentbit'
  tags: [fluentbit, auditd]

- name: Ensure Fluent Bit script directory exists
  ansible.builtin.file:
    path: /etc/fluent-bit/scripts
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: auditd_forward_method == 'fluentbit'
  tags: [fluentbit, auditd]

- name: Determine fluent-bit package and service names for this OS
  ansible.builtin.set_fact:
    auditd_fluentbit_package: "{{ (auditd_fluentbit_package_map.get(ansible_facts.get('ansible_os_family', '')) | default(auditd_fluentbit_package_map['default'])).package | default(auditd_fluentbit_package_default) }}"
    auditd_fluentbit_service: "{{ (auditd_fluentbit_package_map.get(ansible_facts.get('ansible_os_family', '')) | default(auditd_fluentbit_package_map['default'])).service | default(auditd_fluentbit_service_default) }}"
  when: auditd_forward_method == 'fluentbit'
  tags: [fluentbit, auditd]

- name: Add Fluent Bit APT key (Debian family)
  when: (ansible_facts.get('ansible_os_family','') | lower == 'debian') and (auditd_forward_method == 'fluentbit')
  tags: [fluentbit, auditd]
  block:
    - name: Ensure keyrings directory exists
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Ensure gnupg is installed (required for dearmor)
      ansible.builtin.package:
        name: gnupg
        state: present

    - name: Download Fluent Bit GPG key to a temporary file
      ansible.builtin.get_url:
        url: https://packages.fluentbit.io/fluentbit.key
        dest: /usr/share/keyrings/fluentbit.key
        mode: '0644'

    - name: Convert downloaded key to GPG keyring
      ansible.builtin.command: >-
        gpg --dearmor --yes --output /usr/share/keyrings/fluentbit-keyring.gpg /usr/share/keyrings/fluentbit.key
      args:
        creates: /usr/share/keyrings/fluentbit-keyring.gpg

    - name: Remove temporary plain key file
      ansible.builtin.file:
        path: /usr/share/keyrings/fluentbit.key
        state: absent

- name: Add Fluent Bit APT repository (Debian family)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/fluentbit-keyring.gpg] https://packages.fluentbit.io/{{ 'ubuntu' if (ansible_facts.get('ansible_distribution', '') | lower) == 'ubuntu' else 'debian' }} {{ ansible_facts.get('ansible_distribution_release', 'focal') | lower }} main"
    state: present
    filename: fluentbit
  when: (ansible_facts.get('ansible_os_family', '') | lower == 'debian') and (auditd_forward_method == 'fluentbit')
  tags: [fluentbit, auditd]

- name: Update apt cache after adding Fluent Bit repo
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  register: auditd_fluentbit_apt_update
  failed_when: false
  changed_when: false
  when: (ansible_facts.get('ansible_os_family', '') | lower == 'debian') and (auditd_forward_method == 'fluentbit')
  tags: [fluentbit, auditd]

- name: Add Fluent Bit YUM repository (RedHat family)
  ansible.builtin.yum_repository:
    name: fluentbit
    description: Fluent Bit
    baseurl: "https://packages.fluentbit.io/centos/{{ ansible_facts.get('ansible_distribution_major_version', '8') }}/$basearch/"
    gpgcheck: true
    gpgkey: https://packages.fluentbit.io/fluentbit.key
    enabled: true
  when: (ansible_facts.get('ansible_os_family','') | lower == 'redhat') and (auditd_forward_method == 'fluentbit')
  tags: [fluentbit, auditd]

- name: Install Fluent Bit packages (primary and fallback)
  ansible.builtin.package:
    name: "{{ auditd_item }}"
    state: present
  loop:
    - "{{ auditd_fluentbit_package | default('fluent-bit') }}"
    - "{{ auditd_fluentbit_package_fallback | default('td-agent-bit') }}"
  loop_control:
    loop_var: auditd_item
  register: auditd_fluentbit_pkg_results
  failed_when: false
  when: (auditd_forward_method == 'fluentbit') and (auditd_manage_packages | default(true))
  tags: [fluentbit, auditd]

- name: Check whether fluent-bit or td-agent-bit binary exists
  ansible.builtin.command: sh -c 'command -v fluent-bit || command -v td-agent-bit'
  register: auditd_fluentbit_check
  failed_when: false
  changed_when: false
  when: auditd_forward_method == 'fluentbit'
  tags: [fluentbit, auditd]

- name: Set auditd_fluentbit_installed fact based on binary presence
  ansible.builtin.set_fact:
    auditd_fluentbit_installed: "{{ (auditd_fluentbit_check is defined) and (auditd_fluentbit_check.rc == 0) }}"
  when: auditd_forward_method == 'fluentbit'
  tags: [fluentbit, auditd]

- name: Attempt Fluent Bit fallback from GitHub releases (if not installed)
  when:
    - auditd_forward_method == 'fluentbit'
    - auditd_manage_packages | default(true)
    - not (auditd_fluentbit_installed | default(false))
    - auditd_fluentbit_fallback_to_github | default(true)
  tags: [fluentbit, auditd]
  block:
    - name: Query GitHub latest release for fluent-bit
      ansible.builtin.uri:
        url: "https://api.github.com/repos/{{ auditd_fluentbit_github_repo }}/releases/latest"
        return_content: true
        headers:
          Accept: "application/vnd.github.v3+json"
      register: auditd_fluentbit_github_release
      failed_when: false
      changed_when: false

    - name: Set fluent-bit asset download URL (amd64 .deb) from GitHub JSON
      ansible.builtin.set_fact:
        auditd_fluentbit_github_asset_url: >-
          {{ (auditd_fluentbit_github_release.json.assets | selectattr('name', 'match', '(?i).*amd64.*\\.deb$') | map(attribute='browser_download_url') | list)[0] | default('') }}

    - name: Download fluent-bit .deb from GitHub
      ansible.builtin.get_url:
        url: "{{ auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url) }}"
        dest: "/tmp/{{ (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)).split('/')[-1] }}"
        mode: '0644'
      when: (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)) != ''

    - name: Install fluent-bit .deb package from fallback
      ansible.builtin.apt:
        deb: "/tmp/{{ (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)).split('/')[-1] }}"
        state: present
      when: (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)) != ''

    - name: Clean up downloaded fallback .deb
      ansible.builtin.file:
        path: "/tmp/{{ (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)).split('/')[-1] }}"
        state: absent
      when: (auditd_fluentbit_deb_url | default(auditd_fluentbit_github_asset_url)) != ''

- name: Gather service facts for fluent-bit when installed
  ansible.builtin.service_facts:
  when: (auditd_forward_method == 'fluentbit') and (auditd_fluentbit_installed | default(false))
  tags: [fluentbit, auditd]

- name: Set auditd_fluentbit_service_present fact if known service unit exists
  ansible.builtin.set_fact:
    auditd_fluentbit_service_present: >-
      {{ ('fluent-bit' in ansible_facts.get('services', {}))
         or ('td-agent-bit' in ansible_facts.get('services', {}))
         or ((auditd_fluentbit_service | default('')) != '' and ((auditd_fluentbit_service | default('')) in ansible_facts.get('services', {}))) }}
  when: (auditd_forward_method == 'fluentbit') and (auditd_fluentbit_installed | default(false))
  tags: [fluentbit, auditd]

- name: Ensure fluent-bit service is enabled and started when installed and present
  ansible.builtin.service:
    name: "{{ auditd_fluentbit_service | default('fluent-bit') }}"
    enabled: true
    state: started
  when: (auditd_forward_method == 'fluentbit') and (auditd_fluentbit_installed | default(false)) and (auditd_fluentbit_service_present | default(false))
  tags: [fluentbit, auditd]

- name: Render Fluent Bit snippet for audit logs (optional)
  ansible.builtin.template:
    src: fluentbit_audit.conf.j2
    dest: "{{ auditd_fluentbit_conf_path }}"
    owner: root
    group: root
    mode: '0644'
    backup: true
    validate: "sh -c 'command -v fluent-bit >/dev/null 2>&1 && fluent-bit -t -c %s || true'"
  when: auditd_forward_method == 'fluentbit'
  notify: Restart fluent-bit
  tags: [fluentbit, auditd]

- name: Render Fluent Bit Lua enrichment script
  ansible.builtin.template:
    src: audit_action.lua.j2
    dest: /etc/fluent-bit/scripts/audit_action.lua
    owner: root
    group: root
    mode: '0755'
    backup: true
  when: auditd_forward_method == 'fluentbit'
  notify: Restart fluent-bit
  tags: [fluentbit, auditd]

- name: Remove rsyslog imfile snippet when not using rsyslog
  ansible.builtin.file:
    path: "{{ auditd_rsyslog_conf_path }}"
    state: absent
  when: auditd_forward_method != 'rsyslog'
  notify: Restart rsyslog
  tags: [rsyslog, auditd]

- name: Remove Fluent Bit snippet when not using fluentbit
  ansible.builtin.file:
    path: "{{ auditd_fluentbit_conf_path }}"
    state: absent
  when: auditd_forward_method != 'fluentbit'
  notify: Restart fluent-bit
  tags: [fluentbit, auditd]

- name: Ensure auditd is enabled and running
  ansible.builtin.service:
    name: auditd
    enabled: true
    state: started
  when: auditd_manage_services | default(true)
  tags: [service, auditd]
