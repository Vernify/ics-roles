---
# Deploy Jenkins in a Docker container with persistent storage

- name: Ensure Jenkins data root exists
  ansible.builtin.file:
    path: "{{ jenkins_home }}"
    state: directory
    owner: "{{ jenkins_user_uid }}"
    group: "{{ jenkins_user_gid }}"
    mode: "0755"
  tags: [jenkins]

- name: Ensure CI Docker network exists
  community.docker.docker_network:
    name: "{{ jenkins_network_name }}"
    state: present
  tags: [jenkins]

- name: Build list of volumes for Jenkins container
  ansible.builtin.set_fact:
    jenkins__volumes: >-
      {{
        ([jenkins_home + ':/var/jenkins_home']
         + ([jenkins_docker_socket + ':' + jenkins_docker_socket] if jenkins_enable_docker | bool else [])
         + (jenkins_extra_volumes | default([])))
      }}
  tags: [jenkins]

- name: Deploy Jenkins container
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    image: "{{ jenkins_image }}"
    state: started
    restart_policy: "{{ jenkins_restart_policy }}"
    networks:
      - name: "{{ jenkins_network_name }}"
    published_ports:
      - "{{ jenkins_http_port }}:8080"
      - "{{ jenkins_agent_port }}:50000"
    volumes: "{{ jenkins__volumes }}"
    env: "{{ jenkins_env }}"
    shm_size: "{{ jenkins_shm_size }}"
    memory: "{{ jenkins_memory }}"
    cpus: "{{ jenkins_cpus }}"
    healthcheck: "{{ jenkins_healthcheck }}"
  notify: Restart Jenkins
  tags: [jenkins]
