#!/bin/bash
# Graylog Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# --- Config (templated) ---
BACKUP_ROOT="{{ monitoring_backup_base_dir }}/graylog"
OPENSEARCH_URL="{{ monitoring_backup_graylog_opensearch_url }}"
OPENSEARCH_USERNAME="{{ monitoring_backup_graylog_opensearch_username }}"
OPENSEARCH_PASSWORD="{{ monitoring_backup_graylog_opensearch_password }}"
OPENSEARCH_REPOSITORY="{{ monitoring_backup_graylog_opensearch_repository }}"
OPENSEARCH_SNAPSHOT_LOCATION="{{ monitoring_backup_graylog_opensearch_snapshot_location }}"
MONGO_HOST="{{ monitoring_backup_graylog_mongo_host }}"
MONGO_PORT="{{ monitoring_backup_graylog_mongo_port }}"
MONGO_DATABASE="{{ monitoring_backup_graylog_mongo_database }}"
MONGO_USERNAME="{{ monitoring_backup_graylog_mongo_username }}"
MONGO_PASSWORD="{{ monitoring_backup_graylog_mongo_password }}"
MONGO_AUTH_DATABASE="{{ monitoring_backup_graylog_mongo_auth_database }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/graylog_backup.log"
DATE=$(date +%Y%m%d_%H%M%S)
SNAPSHOT_NAME="snapshot_${DATE}"

log(){ echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
fail(){ log "ERROR: $1"; exit 1; }

mkdir -p "$(dirname "$LOG_FILE")" || true
mkdir -p "$BACKUP_ROOT/daily" "$BACKUP_ROOT/weekly" "$BACKUP_ROOT/monthly"
mkdir -p "$OPENSEARCH_SNAPSHOT_LOCATION"

log "Starting Graylog backup"

# Ensure OpenSearch snapshot repository exists
log "Checking OpenSearch snapshot repository"
REPO_CHECK=$(curl -s -u "$OPENSEARCH_USERNAME:$OPENSEARCH_PASSWORD" \
    "$OPENSEARCH_URL/_snapshot/$OPENSEARCH_REPOSITORY" || true)

if echo "$REPO_CHECK" | grep -q "repository_missing_exception"; then
    log "Creating OpenSearch snapshot repository"
    curl -s -u "$OPENSEARCH_USERNAME:$OPENSEARCH_PASSWORD" \
        -X PUT "$OPENSEARCH_URL/_snapshot/$OPENSEARCH_REPOSITORY" \
        -H 'Content-Type: application/json' \
        -d "{
            \"type\": \"fs\",
            \"settings\": {
                \"location\": \"$OPENSEARCH_SNAPSHOT_LOCATION\"
            }
        }" || fail "Failed to create snapshot repository"
fi

# Trigger OpenSearch snapshot
log "Creating OpenSearch snapshot: $SNAPSHOT_NAME"
SNAPSHOT_RESULT=$(curl -s -u "$OPENSEARCH_USERNAME:$OPENSEARCH_PASSWORD" \
    -X PUT "$OPENSEARCH_URL/_snapshot/$OPENSEARCH_REPOSITORY/$SNAPSHOT_NAME?wait_for_completion=true" \
    -H 'Content-Type: application/json' \
    -d '{
        "indices": "graylog_*",
        "ignore_unavailable": true,
        "include_global_state": false
    }')

if echo "$SNAPSHOT_RESULT" | grep -q '"state":"SUCCESS"'; then
    log "OpenSearch snapshot created successfully"
else
    log "WARNING: OpenSearch snapshot may have failed"
    log "Response: $SNAPSHOT_RESULT"
fi

# Backup MongoDB
log "Backing up MongoDB"
MONGO_BACKUP_DIR="${BACKUP_ROOT}/daily/mongodb_${DATE}"
mkdir -p "$MONGO_BACKUP_DIR"

if [[ -n "$MONGO_USERNAME" ]]; then
    mongodump --host "$MONGO_HOST" --port "$MONGO_PORT" \
        --username "$MONGO_USERNAME" --password "$MONGO_PASSWORD" \
        --authenticationDatabase "$MONGO_AUTH_DATABASE" \
        --db "$MONGO_DATABASE" \
        --out "$MONGO_BACKUP_DIR" || fail "MongoDB backup failed"
else
    mongodump --host "$MONGO_HOST" --port "$MONGO_PORT" \
        --db "$MONGO_DATABASE" \
        --out "$MONGO_BACKUP_DIR" || fail "MongoDB backup failed"
fi

# Create archive
ARCHIVE="${BACKUP_ROOT}/daily/graylog_backup_${DATE}.tar.gz"
log "Creating archive $ARCHIVE"
{% if monitoring_backup_compression %}
tar -czf "$ARCHIVE" -C "$MONGO_BACKUP_DIR" . || fail "tar failed"
{% else %}
tar -cf "$ARCHIVE" -C "$MONGO_BACKUP_DIR" . || fail "tar failed"
{% endif %}
rm -rf "$MONGO_BACKUP_DIR"
[[ -f "$ARCHIVE" ]] || fail "Archive not created"
SIZE=$(du -h "$ARCHIVE" | cut -f1)
log "Archive created ($SIZE)"

# Verification
log "Verifying archive"
if ! tar -tzf "$ARCHIVE" >/dev/null 2>&1; then
    fail "Archive verification failed"
fi
log "Verification passed"

{% if monitoring_backup_encryption_enabled %}
log "Encrypting archive"
if openssl enc -aes-256-cbc -salt -in "$ARCHIVE" -out "${ARCHIVE}.enc" \
    -pass file:{{ monitoring_backup_encryption_key_file }}; then
    rm -f "$ARCHIVE"
    ARCHIVE="${ARCHIVE}.enc"
    SIZE=$(du -h "$ARCHIVE" | cut -f1)
    log "Encrypted ($SIZE)"
else
    fail "Encryption failed"
fi
{% endif %}

# Copy to weekly/monthly if applicable
if [[ $(date +%u) -eq 7 ]]; then
    cp "$ARCHIVE" "$BACKUP_ROOT/weekly/" && log "Weekly copy done"
fi
if [[ $(date +%d) -eq 01 ]]; then
    cp "$ARCHIVE" "$BACKUP_ROOT/monthly/" && log "Monthly copy done"
fi

# Create snapshot metadata file
SNAPSHOT_INFO="${BACKUP_ROOT}/daily/opensearch_snapshot_${DATE}.txt"
echo "snapshot_name: $SNAPSHOT_NAME" > "$SNAPSHOT_INFO"
echo "repository: $OPENSEARCH_REPOSITORY" >> "$SNAPSHOT_INFO"
echo "location: $OPENSEARCH_SNAPSHOT_LOCATION" >> "$SNAPSHOT_INFO"
echo "date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$SNAPSHOT_INFO"

log "Graylog backup completed successfully"
exit 0
