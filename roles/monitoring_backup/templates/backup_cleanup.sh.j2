#!/bin/bash
# Backup Cleanup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ monitoring_backup_base_dir }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/cleanup.log"
RETENTION_DAYS={{ monitoring_backup_retention_days }}
RETENTION_WEEKS={{ monitoring_backup_retention_weeks }}
RETENTION_MONTHS={{ monitoring_backup_retention_months }}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

cleanup_old_backups() {
    local service="$1"
    local backup_type="$2"
    local retention_days="$3"
    local backup_path="$BACKUP_DIR/$service/$backup_type"
    
    if [[ ! -d "$backup_path" ]]; then
        log "Backup directory not found: $backup_path"
        return 0
    fi
    
    local pattern="${service}_backup_*.tar.gz*"
    local count_before
    count_before=$(find "$backup_path" -type f -name "$pattern" -print 2>/dev/null | wc -l)
    
    # Collect files older than retention_days
    IFS=$'\n' read -r -d '' -a files_to_delete < <(find "$backup_path" -type f -name "$pattern" -mtime +"$retention_days" -print 2>/dev/null || true; printf '\0')
    
    local deleted=0
    if [[ ${{'{#'}}files_to_delete[@]} -gt 0 ]]; then
        for f in "${files_to_delete[@]}"; do
            if [[ -z "$f" ]]; then
                continue
            fi
            rm -f -- "$f" && log "Removed: $f"
            deleted=$((deleted + 1))
        done
    fi
    
    if [[ $deleted -gt 0 ]]; then
        log "Cleaned up $deleted old $service $backup_type backups (retention: $retention_days days)"
    else
        log "No old $service $backup_type backups to clean up"
    fi
}

log "Starting backup cleanup"

# Ensure log file directory exists
mkdir -p "$(dirname "$LOG_FILE")"
touch "$LOG_FILE" || true

# Print config for troubleshooting
log "Config: BACKUP_DIR=$BACKUP_DIR, RETENTION_DAYS=$RETENTION_DAYS, RETENTION_WEEKS=$RETENTION_WEEKS, RETENTION_MONTHS=$RETENTION_MONTHS"

{% if monitoring_backup_grafana_enabled %}
# Cleanup Grafana backups
cleanup_old_backups "grafana" "daily" $RETENTION_DAYS
cleanup_old_backups "grafana" "weekly" $((RETENTION_WEEKS * 7))
cleanup_old_backups "grafana" "monthly" $((RETENTION_MONTHS * 30))
{% endif %}

{% if monitoring_backup_graylog_enabled %}
# Cleanup Graylog backups
cleanup_old_backups "graylog" "daily" $RETENTION_DAYS
cleanup_old_backups "graylog" "weekly" $((RETENTION_WEEKS * 7))
cleanup_old_backups "graylog" "monthly" $((RETENTION_MONTHS * 30))

# Cleanup Graylog snapshot metadata files
log "Cleaning up old OpenSearch snapshot metadata"
find "$BACKUP_DIR/graylog/daily" -name "opensearch_snapshot_*.txt" -mtime +$RETENTION_DAYS -delete 2>/dev/null || true
find "$BACKUP_DIR/graylog/daily" -name "mongodb_*" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} + 2>/dev/null || true
{% endif %}

# Cleanup old log files
log "Cleaning up old log files"
find "{{ monitoring_backup_log_dir }}" -name "*.log" -mtime +{{ monitoring_backup_logrotate_retention }} -delete 2>/dev/null || true

log "Backup cleanup completed"

# Generate cleanup summary
log "=== Cleanup Summary ==="
{% if monitoring_backup_grafana_enabled %}
log "Grafana daily backups remaining: $(find "$BACKUP_DIR/grafana/daily" -name "grafana_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
log "Grafana weekly backups remaining: $(find "$BACKUP_DIR/grafana/weekly" -name "grafana_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
log "Grafana monthly backups remaining: $(find "$BACKUP_DIR/grafana/monthly" -name "grafana_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
{% endif %}
{% if monitoring_backup_graylog_enabled %}
log "Graylog daily backups remaining: $(find "$BACKUP_DIR/graylog/daily" -name "graylog_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
log "Graylog weekly backups remaining: $(find "$BACKUP_DIR/graylog/weekly" -name "graylog_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
log "Graylog monthly backups remaining: $(find "$BACKUP_DIR/graylog/monthly" -name "graylog_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)"
{% endif %}
log "Total backup space used: $(du -sh "$BACKUP_DIR" 2>/dev/null | cut -f1)"
