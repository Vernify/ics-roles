#!/bin/bash
# Backup Monitoring Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ monitoring_backup_base_dir }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/monitor.log"
ALERT_THRESHOLD_HOURS=26  # Alert if no backup in 26 hours (1 day + 2 hour buffer)

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

check_recent_backup() {
    local service="$1"
    local backup_path="$BACKUP_DIR/$service/daily"
    
    if [[ ! -d "$backup_path" ]]; then
        log "WARNING: Backup directory not found: $backup_path"
        return 1
    fi
    
    local latest_backup=$(find "$backup_path" -name "${service}_backup_*.tar.gz*" -type f 2>/dev/null | sort | tail -1)
    
    if [[ -z "$latest_backup" ]]; then
        log "ALERT: No backups found for $service"
        return 1
    fi
    
    local backup_age_seconds=$(($(date +%s) - $(stat -c%Y "$latest_backup" 2>/dev/null || stat -f%m "$latest_backup" 2>/dev/null)))
    local backup_age_hours=$((backup_age_seconds / 3600))
    
    log "Latest $service backup: $(basename "$latest_backup") (${backup_age_hours}h old)"
    
    if [[ $backup_age_hours -gt $ALERT_THRESHOLD_HOURS ]]; then
        log "ALERT: $service backup is older than ${ALERT_THRESHOLD_HOURS} hours"
        return 1
    fi
    
    return 0
}

check_backup_space() {
    local backup_space=$(df -h "$BACKUP_DIR" | awk 'NR==2 {print $5}' | sed 's/%//')
    
    log "Backup directory space usage: ${backup_space}%"
    
    if [[ $backup_space -gt 90 ]]; then
        log "ALERT: Backup directory is ${backup_space}% full"
        return 1
    elif [[ $backup_space -gt 80 ]]; then
        log "WARNING: Backup directory is ${backup_space}% full"
    fi
    
    return 0
}

check_backup_count() {
    local service="$1"
    
    {% raw %}
    local daily_count=$(find "$BACKUP_DIR/$service/daily" -name "${service}_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)
    local weekly_count=$(find "$BACKUP_DIR/$service/weekly" -name "${service}_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)
    local monthly_count=$(find "$BACKUP_DIR/$service/monthly" -name "${service}_backup_*.tar.gz*" -type f 2>/dev/null | wc -l)
    {% endraw %}
    
    log "$service backup counts: daily=$daily_count, weekly=$weekly_count, monthly=$monthly_count"
    
    if [[ $daily_count -eq 0 ]]; then
        log "ALERT: No daily backups found for $service"
        return 1
    fi
    
    return 0
}

log "Starting backup health check"

exit_code=0

{% if monitoring_backup_grafana_enabled %}
# Check Grafana backups
log "=== Grafana Backup Status ==="
if ! check_recent_backup "grafana"; then
    exit_code=1
fi
if ! check_backup_count "grafana"; then
    exit_code=1
fi
{% endif %}

{% if monitoring_backup_graylog_enabled %}
# Check Graylog backups
log "=== Graylog Backup Status ==="
if ! check_recent_backup "graylog"; then
    exit_code=1
fi
if ! check_backup_count "graylog"; then
    exit_code=1
fi
{% endif %}

# Check backup space
log "=== Backup Storage Status ==="
if ! check_backup_space; then
    exit_code=1
fi

# Check log file sizes
log "=== Log File Status ==="
{% raw %}
log "Log directory size: $(du -sh {{ monitoring_backup_log_dir }} 2>/dev/null | cut -f1)"
{% endraw %}

if [[ $exit_code -eq 0 ]]; then
    log "All backup health checks passed"
else
    log "Some backup health checks failed - review alerts above"
fi

exit $exit_code
