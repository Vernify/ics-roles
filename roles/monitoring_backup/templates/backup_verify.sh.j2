#!/bin/bash
# Backup Verification Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ monitoring_backup_base_dir }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/verify.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

verify_backup() {
    local service="$1"
    local backup_file="$2"
    
    if [[ ! -f "$backup_file" ]]; then
        log "ERROR: Backup file not found: $backup_file"
        return 1
    fi
    
    log "Verifying $service backup: $backup_file"
    
    # Check file size
    local file_size=$(stat -c%s "$backup_file" 2>/dev/null || stat -f%z "$backup_file" 2>/dev/null)
    if [[ $file_size -lt 1000 ]]; then
        log "ERROR: Backup file seems too small: $file_size bytes"
        return 1
    fi
    
    # For encrypted files, we can only do basic checks
    if [[ "$backup_file" == *.enc ]]; then
        log "Backup is encrypted, performing basic validation"
        if ! head -c 100 "$backup_file" >/dev/null 2>&1; then
            log "ERROR: Cannot read encrypted backup file"
            return 1
        fi
        log "Encrypted backup file validation passed"
        return 0
    fi
    
    # For tar.gz files, verify archive integrity
    if ! tar -tzf "$backup_file" >/dev/null 2>&1; then
        log "ERROR: Backup archive is corrupted"
        return 1
    fi
    
    # Service-specific checks
    case "$service" in
        "grafana")
            if tar -tzf "$backup_file" | grep -q "dashboards/\|provisioning/"; then
                log "Grafana backup contains expected files"
            else
                log "WARNING: Grafana backup may be incomplete"
            fi
            ;;
        "graylog")
            if tar -tzf "$backup_file" | grep -q "\.bson\|\.json"; then
                log "Graylog backup contains MongoDB data"
            else
                log "WARNING: Graylog backup may be incomplete"
            fi
            ;;
    esac
    
    log "$service backup verification passed: $backup_file"
    return 0
}

usage() {
    echo "Usage: $0 [grafana|graylog|all] [latest|backup_file]"
    echo ""
    echo "Examples:"
    echo "  $0 all latest                                  # Verify latest backups for all services"
    echo "  $0 grafana latest                              # Verify latest Grafana backup"
    echo "  $0 graylog /path/to/specific/backup.tar.gz     # Verify specific backup file"
    echo ""
    exit 1
}

# Parse arguments
SERVICE="${1:-all}"
BACKUP_SOURCE="${2:-latest}"

if [[ "$SERVICE" != "grafana" ]] && [[ "$SERVICE" != "graylog" ]] && [[ "$SERVICE" != "all" ]]; then
    usage
fi

log "Starting backup verification"

exit_code=0

verify_service() {
    local svc="$1"
    local source="$2"
    
    if [[ "$source" == "latest" ]]; then
        local pattern="${svc}_backup_*.tar.gz*"
        local backup_file=$(find "$BACKUP_DIR/$svc/daily" -name "$pattern" -type f 2>/dev/null | sort | tail -1)
        if [[ -z "$backup_file" ]]; then
            log "ERROR: No backup files found for $svc"
            return 1
        fi
    else
        local backup_file="$source"
    fi
    
    if ! verify_backup "$svc" "$backup_file"; then
        return 1
    fi
    
    return 0
}

# Verify requested services
if [[ "$SERVICE" == "all" ]]; then
    log "Verifying all service backups"
    {% if monitoring_backup_grafana_enabled %}
    if ! verify_service "grafana" "$BACKUP_SOURCE"; then
        exit_code=1
    fi
    {% endif %}
    {% if monitoring_backup_graylog_enabled %}
    if ! verify_service "graylog" "$BACKUP_SOURCE"; then
        exit_code=1
    fi
    {% endif %}
else
    if ! verify_service "$SERVICE" "$BACKUP_SOURCE"; then
        exit_code=1
    fi
fi

if [[ $exit_code -eq 0 ]]; then
    log "All backup verifications passed"
else
    log "Some backup verifications failed"
fi

exit $exit_code
