#!/bin/bash
# Backup Restoration Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

BACKUP_DIR="{{ monitoring_backup_base_dir }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/restore.log"
GRAFANA_API_URL="{{ monitoring_backup_grafana_api_url }}"
GRAFANA_API_KEY="{{ monitoring_backup_grafana_api_key }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

fail() {
    log "ERROR: $1"
    exit 1
}

usage() {
    echo "Usage: $0 [grafana|graylog] <backup_file>"
    echo ""
    echo "Examples:"
    echo "  $0 grafana /opt/backups/grafana/daily/grafana_backup_20240101_010000.tar.gz"
    echo "  $0 graylog /opt/backups/graylog/daily/graylog_backup_20240101_010000.tar.gz"
    echo ""
    echo "WARNINGS:"
    echo "  - Restoration is a destructive operation"
    echo "  - Stop the service before restoring"
    echo "  - Test restorations on non-production systems first"
    echo "  - Always backup current state before restoring"
    echo ""
    exit 1
}

restore_grafana() {
    local backup_file="$1"
    
    log "Starting Grafana restoration from $backup_file"
    
    # Check if backup file exists
    [[ -f "$backup_file" ]] || fail "Backup file not found: $backup_file"
    
    # Decrypt if necessary
    {% if monitoring_backup_encryption_enabled %}
    if [[ "$backup_file" == *.enc ]]; then
        log "Decrypting backup"
        local decrypted="${backup_file%.enc}"
        openssl enc -aes-256-cbc -d -in "$backup_file" -out "$decrypted" \
            -pass file:{{ monitoring_backup_encryption_key_file }} || fail "Decryption failed"
        backup_file="$decrypted"
    fi
    {% endif %}
    
    # Extract to temp directory
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT
    
    log "Extracting backup"
    tar -xzf "$backup_file" -C "$TEMP_DIR" || fail "Extraction failed"
    
    # Restore dashboards via API
    if [[ -d "$TEMP_DIR/dashboards" ]] && [[ -n "$GRAFANA_API_KEY" ]]; then
        log "Restoring dashboards via API"
        for dashboard in "$TEMP_DIR/dashboards"/*.json; do
            [[ -f "$dashboard" ]] || continue
            local uid=$(basename "$dashboard" .json)
            log "Restoring dashboard: $uid"
            
            local payload=$(jq -n --slurpfile dash "$dashboard" '{
                dashboard: $dash[0],
                overwrite: true
            }')
            
            curl -s -X POST -H "Authorization: Bearer $GRAFANA_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$payload" \
                "$GRAFANA_API_URL/api/dashboards/db" || log "WARNING: Failed to restore dashboard $uid"
        done
    fi
    
    log "Grafana restoration completed"
    log "NOTE: Manual steps may be required:"
    log "  - Restore database if backed up (see backup contents)"
    log "  - Restore provisioning files to {{ monitoring_backup_grafana_config_dir }}/provisioning/"
    log "  - Restart Grafana service"
}

restore_graylog() {
    local backup_file="$1"
    
    log "Starting Graylog restoration from $backup_file"
    
    # Check if backup file exists
    [[ -f "$backup_file" ]] || fail "Backup file not found: $backup_file"
    
    log "CRITICAL: Graylog restoration requires manual steps"
    log ""
    log "To restore Graylog:"
    log ""
    log "1. STOP Graylog services:"
    log "   systemctl stop graylog-server"
    log ""
    log "2. Restore OpenSearch snapshot:"
    log "   - Check snapshot info in: $(dirname "$backup_file")/opensearch_snapshot_*.txt"
    log "   - Use OpenSearch API to restore:"
    log "     curl -X POST \"{{ monitoring_backup_graylog_opensearch_url }}/_snapshot/{{ monitoring_backup_graylog_opensearch_repository }}/<snapshot_name>/_restore\""
    log ""
    log "3. Restore MongoDB from this backup:"
    log "   - Extract: tar -xzf $backup_file -C /tmp/"
    log "   - Restore: mongorestore --host {{ monitoring_backup_graylog_mongo_host }} --port {{ monitoring_backup_graylog_mongo_port }} \\"
    log "              --db {{ monitoring_backup_graylog_mongo_database }} /tmp/{{ monitoring_backup_graylog_mongo_database }}/"
    log ""
    log "4. START Graylog services:"
    log "   systemctl start graylog-server"
    log ""
    log "5. Verify restoration in Graylog web interface"
}

# Parse arguments
SERVICE="${1:-}"
BACKUP_FILE="${2:-}"

if [[ -z "$SERVICE" ]] || [[ -z "$BACKUP_FILE" ]]; then
    usage
fi

case "$SERVICE" in
    grafana)
        restore_grafana "$BACKUP_FILE"
        ;;
    graylog)
        restore_graylog "$BACKUP_FILE"
        ;;
    *)
        usage
        ;;
esac
