#!/bin/bash
# Backup Wrapper Orchestration Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

LOG_FILE="{{ monitoring_backup_log_dir }}/wrapper.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "====================================="
log "Starting monitoring backup orchestration"
log "====================================="

EXIT_CODE=0

{% if monitoring_backup_grafana_enabled %}
# Run Grafana backup
log "Running Grafana backup..."
if /usr/local/bin/grafana_backup.sh; then
    log "Grafana backup completed successfully"
else
    log "ERROR: Grafana backup failed"
    EXIT_CODE=1
fi
{% endif %}

{% if monitoring_backup_graylog_enabled %}
# Run Graylog backup
log "Running Graylog backup..."
if /usr/local/bin/graylog_backup.sh; then
    log "Graylog backup completed successfully"
else
    log "ERROR: Graylog backup failed"
    EXIT_CODE=1
fi
{% endif %}

{% if monitoring_backup_verify_enabled %}
# Run verification
log "Running backup verification..."
if /usr/local/bin/monitoring_backup_verify.sh all latest; then
    log "Backup verification completed successfully"
else
    log "ERROR: Backup verification failed"
    {% if monitoring_backup_verify_fail_on_error %}
    EXIT_CODE=1
    {% else %}
    log "Continuing despite verification failure (verify_fail_on_error=false)"
    {% endif %}
fi
{% endif %}

# Run cleanup
log "Running backup cleanup..."
if /usr/local/bin/monitoring_backup_cleanup.sh; then
    log "Backup cleanup completed successfully"
else
    log "ERROR: Backup cleanup failed"
    EXIT_CODE=1
fi

log "====================================="
if [[ $EXIT_CODE -eq 0 ]]; then
    log "Monitoring backup orchestration completed successfully"
else
    log "Monitoring backup orchestration completed with errors"
fi
log "====================================="

exit $EXIT_CODE
