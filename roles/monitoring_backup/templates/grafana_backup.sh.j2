#!/bin/bash
# Grafana Backup Script
# Generated by Ansible - Do not edit manually

set -euo pipefail

# --- Config (templated) ---
BACKUP_ROOT="{{ monitoring_backup_base_dir }}/grafana"
GRAFANA_API_URL="{{ monitoring_backup_grafana_api_url }}"
GRAFANA_API_KEY="{{ monitoring_backup_grafana_api_key }}"
GRAFANA_CONFIG_DIR="{{ monitoring_backup_grafana_config_dir }}"
GRAFANA_DATA_DIR="{{ monitoring_backup_grafana_data_dir }}"
LOG_FILE="{{ monitoring_backup_log_dir }}/grafana_backup.log"
DATE=$(date +%Y%m%d_%H%M%S)
ARCHIVE="${BACKUP_ROOT}/daily/grafana_backup_${DATE}.tar.gz"
DB_BACKUP_ENABLED="{{ monitoring_backup_grafana_db_enabled }}"
DB_TYPE="{{ monitoring_backup_grafana_db_type }}"
DB_PATH="{{ monitoring_backup_grafana_db_path }}"
{% if monitoring_backup_grafana_db_type == 'postgres' %}
PG_HOST="{{ monitoring_backup_grafana_pg_host }}"
PG_PORT="{{ monitoring_backup_grafana_pg_port }}"
PG_DATABASE="{{ monitoring_backup_grafana_pg_database }}"
PG_USER="{{ monitoring_backup_grafana_pg_user }}"
export PGPASSWORD="{{ monitoring_backup_grafana_pg_password }}"
{% endif %}

log(){ echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }
fail(){ log "ERROR: $1"; exit 1; }

mkdir -p "$(dirname "$LOG_FILE")" || true
[[ -d "$GRAFANA_CONFIG_DIR" ]] || fail "Grafana config dir not found: $GRAFANA_CONFIG_DIR"

mkdir -p "$BACKUP_ROOT/daily" "$BACKUP_ROOT/weekly" "$BACKUP_ROOT/monthly"

TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

log "Starting Grafana backup"

# Export dashboards via API
if [[ -n "$GRAFANA_API_KEY" ]]; then
    log "Exporting dashboards via API"
    mkdir -p "$TEMP_DIR/dashboards"
    
    # Get all dashboard UIDs
    DASHBOARD_UIDS=$(curl -s -H "Authorization: Bearer $GRAFANA_API_KEY" \
        "$GRAFANA_API_URL/api/search?type=dash-db" | \
        jq -r '.[].uid' || true)
    
    if [[ -n "$DASHBOARD_UIDS" ]]; then
        for uid in $DASHBOARD_UIDS; do
            curl -s -H "Authorization: Bearer $GRAFANA_API_KEY" \
                "$GRAFANA_API_URL/api/dashboards/uid/$uid" | \
                jq '.dashboard' > "$TEMP_DIR/dashboards/${uid}.json" || \
                log "WARNING: Failed to export dashboard $uid"
        done
        log "Exported $(ls -1 $TEMP_DIR/dashboards/*.json 2>/dev/null | wc -l) dashboards"
    else
        log "No dashboards found to export"
    fi
fi

# Backup provisioning files
if [[ -d "$GRAFANA_CONFIG_DIR/provisioning" ]]; then
    log "Backing up provisioning files"
    cp -r "$GRAFANA_CONFIG_DIR/provisioning" "$TEMP_DIR/"
fi

# Backup main config file
if [[ -f "$GRAFANA_CONFIG_DIR/grafana.ini" ]]; then
    log "Backing up grafana.ini"
    cp "$GRAFANA_CONFIG_DIR/grafana.ini" "$TEMP_DIR/"
fi

# Database backup
if [[ "$DB_BACKUP_ENABLED" =~ ^(true|True|1)$ ]]; then
    log "Backing up database"
    mkdir -p "$TEMP_DIR/database"
    
    case "$DB_TYPE" in
        sqlite3)
            if [[ -f "$DB_PATH" ]]; then
                sqlite3 "$DB_PATH" ".backup '$TEMP_DIR/database/grafana.db'" || \
                    log "WARNING: SQLite backup failed"
            else
                log "WARNING: SQLite database not found at $DB_PATH"
            fi
            ;;
        postgres)
            pg_dump -h "$PG_HOST" -p "$PG_PORT" -U "$PG_USER" -d "$PG_DATABASE" \
                -f "$TEMP_DIR/database/grafana.sql" || \
                log "WARNING: PostgreSQL backup failed"
            ;;
        *)
            log "WARNING: Unknown database type: $DB_TYPE"
            ;;
    esac
fi

# Create archive
log "Creating archive $ARCHIVE"
{% if monitoring_backup_compression %}
tar -czf "$ARCHIVE" -C "$TEMP_DIR" . || fail "tar failed"
{% else %}
tar -cf "$ARCHIVE" -C "$TEMP_DIR" . || fail "tar failed"
{% endif %}
[[ -f "$ARCHIVE" ]] || fail "Archive not created"
SIZE=$(du -h "$ARCHIVE" | cut -f1)
log "Archive created ($SIZE)"

# Verification
log "Verifying archive"
if ! tar -tzf "$ARCHIVE" >/dev/null 2>&1; then
    fail "Archive verification failed"
fi
log "Verification passed"

{% if monitoring_backup_encryption_enabled %}
log "Encrypting archive"
if openssl enc -aes-256-cbc -salt -in "$ARCHIVE" -out "${ARCHIVE}.enc" \
    -pass file:{{ monitoring_backup_encryption_key_file }}; then
    rm -f "$ARCHIVE"
    ARCHIVE="${ARCHIVE}.enc"
    SIZE=$(du -h "$ARCHIVE" | cut -f1)
    log "Encrypted ($SIZE)"
else
    fail "Encryption failed"
fi
{% endif %}

# Copy to weekly/monthly if applicable
if [[ $(date +%u) -eq 7 ]]; then
    cp "$ARCHIVE" "$BACKUP_ROOT/weekly/" && log "Weekly copy done"
fi
if [[ $(date +%d) -eq 01 ]]; then
    cp "$ARCHIVE" "$BACKUP_ROOT/monthly/" && log "Monthly copy done"
fi

log "Grafana backup completed successfully"
exit 0
