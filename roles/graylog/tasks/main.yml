---
# Deploy Graylog stack: MongoDB, OpenSearch, and Graylog

- name: "Reset Graylog data and volumes (DANGEROUS: destroys data)"
  when: graylog_reset_data | bool
  tags: [monitoring, graylog, reset]
  block:
    - name: Stop and remove Graylog container
      community.docker.docker_container:
        name: "{{ graylog_container_name }}"
        state: absent
        force_kill: true
        remove_volumes: false
      failed_when: false

    - name: Stop and remove OpenSearch container
      community.docker.docker_container:
        name: "{{ graylog_opensearch_container_name }}"
        state: absent
        force_kill: true
        remove_volumes: false
      failed_when: false

    - name: Stop and remove MongoDB container
      community.docker.docker_container:
        name: "{{ graylog_mongo_container_name }}"
        state: absent
        force_kill: true
        remove_volumes: false
      failed_when: false

    - name: Remove named volumes
      community.docker.docker_volume:
        name: "{{ graylog_volume_item }}"
        state: absent
      loop:
        - "{{ graylog_data_volume }}"
        - "{{ graylog_journal_volume }}"
        - "{{ graylog_mongo_volume }}"
        - "{{ graylog_opensearch_volume }}"
      loop_control:
        loop_var: graylog_volume_item

    - name: Wipe host data directories
      ansible.builtin.file:
        path: "{{ graylog_data_dir_item }}"
        state: absent
      loop:
        - "{{ graylog_volumes_root }}/graylog/data"
        - "{{ graylog_volumes_root }}/graylog/journal"
        - "{{ graylog_volumes_root }}/mongo/data"
        - "{{ graylog_volumes_root }}/opensearch/data"
      loop_control:
        loop_var: graylog_data_dir_item

- name: Assert Graylog secrets are provided
  ansible.builtin.assert:
    that:
      - graylog_password_secret | length > 0
      - graylog_root_password_sha2 | length == 64
    fail_msg: "graylog_password_secret and graylog_root_password_sha2 must be set (use Ansible Vault/Hashicorp Vault)."
  tags: [monitoring, graylog]
  
# Host UID sanity checks: warn if the numeric UIDs used by containers map to unexpected
# host users. When host paths are bind-mounted into containers, file ownership is
# represented by numeric UID/GID on the host. It's normal for a container that runs
# as UID 999 to show a host user (e.g., dnsmasq) owning the directory; this is a
# mapping artifact. We warn so operators can decide whether to switch to named
# volumes or reconcile host UIDs.
- name: Check host mapping for MongoDB UID
  ansible.builtin.command:
    cmd: "getent passwd {{ graylog_mongo_user_id }}"
    warn: false
  register: mongo_uid_map
  changed_when: false
  tags: [monitoring, graylog]

- name: Warn if MongoDB UID maps to a non-root host user
  ansible.builtin.debug:
    msg: |
      The MongoDB container runs as UID/GID {{ graylog_mongo_user_id }}/{{ graylog_mongo_group_id }}.
      On this host that numeric UID maps to: {{ mongo_uid_map.stdout | default('no entry') }}.
      If this user is unexpected (for example dnsmasq), consider using Docker named volumes
      or adjusting ownership. This is informational only.
  when: mongo_uid_map.stdout is defined and mongo_uid_map.stdout != ''
  tags: [monitoring, graylog]

- name: Check host mapping for OpenSearch UID
  ansible.builtin.command:
    cmd: "getent passwd {{ graylog_opensearch_user_id }}"
    warn: false
  register: opensearch_uid_map
  changed_when: false
  tags: [monitoring, graylog]

- name: Warn if OpenSearch UID maps to a non-root host user
  ansible.builtin.debug:
    msg: |
      The OpenSearch container runs as UID/GID {{ graylog_opensearch_user_id }}/{{ graylog_opensearch_group_id }}.
      On this host that numeric UID maps to: {{ opensearch_uid_map.stdout | default('no entry') }}.
      If this user is unexpected, consider using Docker named volumes or adjusting ownership.
  when: opensearch_uid_map.stdout is defined and opensearch_uid_map.stdout != ''
  tags: [monitoring, graylog]

- name: Ensure MongoDB data directory exists with correct ownership
  ansible.builtin.file:
    path: "{{ graylog_volumes_root }}/mongo/data"
    state: directory
    owner: "{{ graylog_mongo_user_id }}"
    group: "{{ graylog_mongo_group_id }}"
    mode: '0755'
  tags: [monitoring, graylog]

- name: Ensure OpenSearch data directory exists with correct ownership
  ansible.builtin.file:
    path: "{{ graylog_volumes_root }}/opensearch/data"
    state: directory
    owner: "{{ graylog_opensearch_user_id }}"
    group: "{{ graylog_opensearch_group_id }}"
    mode: '0775'
  tags: [monitoring, graylog]

- name: Ensure Graylog data directories exist with correct ownership
  ansible.builtin.file:
    path: "{{ graylog_owned_dir_item }}"
    state: directory
    owner: "{{ graylog_user_id }}"
    group: "{{ graylog_group_id }}"
    mode: '0775'
  loop:
    - "{{ graylog_volumes_root }}/graylog/data"
    - "{{ graylog_volumes_root }}/graylog/data/config"
    - "{{ graylog_volumes_root }}/graylog/journal"
  loop_control:
    loop_var: graylog_owned_dir_item
  tags: [monitoring, graylog]

- name: Render Graylog configuration
  ansible.builtin.template:
    src: graylog.conf.j2
    dest: "{{ graylog_volumes_root }}/graylog/data/config/graylog.conf"
    owner: "{{ graylog_user_id }}"
    group: "{{ graylog_group_id }}"
    mode: '0640'
  tags: [monitoring, graylog]
  notify:
    - restart graylog
    - "restart monitoring proxy"

- name: Create Graylog named volumes bound to host paths
  community.docker.docker_volume:
    name: "{{ graylog_volume_map_item.name }}"
    state: present
    driver: local
    driver_options:
      o: bind
      type: none
      device: "{{ graylog_volume_map_item.host_path }}"
  loop:
    - { name: "{{ graylog_mongo_volume }}", host_path: "{{ graylog_volumes_root }}/mongo/data" }
    - { name: "{{ graylog_opensearch_volume }}", host_path: "{{ graylog_volumes_root }}/opensearch/data" }
    - { name: "{{ graylog_data_volume }}", host_path: "{{ graylog_volumes_root }}/graylog/data" }
    - { name: "{{ graylog_journal_volume }}", host_path: "{{ graylog_volumes_root }}/graylog/journal" }
  loop_control:
    label: "{{ graylog_volume_map_item.name }} -> {{ graylog_volume_map_item.host_path }}"
    loop_var: graylog_volume_map_item
  tags: [monitoring, graylog]

- name: Ensure MongoDB container for Graylog is running
  community.docker.docker_container:
    name: "{{ graylog_mongo_container_name }}"
    image: "{{ graylog_mongo_image }}"
    restart_policy: "{{ graylog_mongo_restart_policy }}"
    networks:
      - name: "{{ graylog_network }}"
    env: {}
    volumes:
      - "{{ graylog_mongo_volume }}:/data/db"
    state: started
    pull: missing
  tags: [monitoring, graylog]
  notify:
    - restart graylog
    - "restart monitoring proxy"

- name: Ensure OpenSearch container for Graylog is running
  community.docker.docker_container:
    name: "{{ graylog_opensearch_container_name }}"
    image: "{{ graylog_opensearch_image }}"
    restart_policy: "{{ graylog_opensearch_restart_policy }}"
    networks:
      - name: "{{ graylog_network }}"
    env:
      discovery.type: "single-node"
      plugins.security.disabled: "true"
      OPENSEARCH_JAVA_OPTS: "{{ graylog_opensearch_java_opts }}"
    ulimits:
      - nofile:262144:262144
    volumes:
      - "{{ graylog_opensearch_volume }}:/usr/share/opensearch/data"
    state: started
    pull: missing
  tags: [monitoring, graylog]
  notify:
    - restart graylog
    - "restart monitoring proxy"

- name: Wait for OpenSearch API to become ready
  ansible.builtin.command: >-
    docker exec {{ graylog_opensearch_container_name }}
    curl -sSf http://localhost:9200 -o /dev/null
  register: graylog_opensearch_ready
  retries: 30
  delay: 5
  changed_when: false
  until: graylog_opensearch_ready.rc == 0
  tags: [monitoring, graylog]

- name: Pre-pull Graylog image if missing
  community.docker.docker_image:
    name: "{{ graylog_image }}"
    source: pull
  tags: [monitoring, graylog]
  register: graylog_image_pull_result
  # fail early if image cannot be pulled so the operator sees the problem before container start
  failed_when: graylog_image_pull_result is failed

- name: Ensure Graylog container is running
  community.docker.docker_container:
    name: "{{ graylog_container_name }}"
    image: "{{ graylog_image }}"
    restart_policy: "{{ graylog_restart_policy }}"
    networks:
      - name: "{{ graylog_network }}"
    env:
      GRAYLOG_HTTP_BIND_ADDRESS: "{{ graylog_http_bind }}"
      GRAYLOG_HTTP_PUBLISH_URI: "{{ graylog_http_publish_uri }}"
      GRAYLOG_HTTP_EXTERNAL_URI: "{{ graylog_http_external_uri }}"
      GRAYLOG_HTTP_STATIC_CONTENT_SECURITY_POLICY: "{{ graylog_http_csp_policy }}"
      GRAYLOG_ROOT_TIMEZONE: "UTC"
      GRAYLOG_PASSWORD_SECRET: "{{ graylog_password_secret }}"
      GRAYLOG_ROOT_PASSWORD_SHA2: "{{ graylog_root_password_sha2 }}"
      GRAYLOG_MONGODB_URI: "mongodb://{{ graylog_mongo_container_name }}:27017/graylog"
      GRAYLOG_OPENSEARCH_HOSTS: "http://{{ graylog_opensearch_container_name }}:9200"
    published_ports: "{{ graylog_published_ports }}"
    volumes:
      - "{{ graylog_data_volume }}:/usr/share/graylog/data"
      - "{{ graylog_journal_volume }}:/usr/share/graylog/data/journal"
    state: started
    pull: missing
  tags: [monitoring, graylog]
  notify:
    - restart graylog
    - "restart monitoring proxy"


- name: Wait for Graylog API to become ready
  ansible.builtin.uri:
    url: "http://localhost:9000/api/system/lbstatus"
    method: GET
    status_code: 200
  register: graylog_api_ready
  retries: 30
  delay: 10
  changed_when: false
  until: graylog_api_ready.status == 200
  tags: [monitoring, graylog]

- name: "Import Graylog artifacts (pipelines and pipeline definitions)"
  ansible.builtin.include_tasks: import_gray_artifacts.yml
  when: graylog_upload_enabled | bool
  tags: [monitoring, graylog, graylog_artifacts]

- name: Create Graylog inputs
  when: graylog_create_inputs | bool
  tags: [monitoring, graylog]
  block:
    - name: Get existing Graylog inputs
      ansible.builtin.uri:
        url: "http://localhost:9000/api/system/inputs"
        method: GET
        user: "{{ graylog_api_user }}"
        password: "{{ graylog_api_password }}"
        headers:
          Accept: "application/json"
          X-Requested-By: "ansible"
        status_code: 200
      register: graylog_existing_inputs
      no_log: true

    - name: Build list of existing input titles
      ansible.builtin.set_fact:
        graylog_existing_titles: "{{ graylog_existing_inputs.json.inputs | map(attribute='title') | list }}"
      when: graylog_existing_inputs is defined and graylog_existing_inputs.json is defined

    - name: Ensure Graylog inputs exist (idempotent by type+port)
      ansible.builtin.uri:
        url: "http://localhost:9000/api/system/inputs"
        method: POST
        user: "{{ graylog_api_user }}"
        password: "{{ graylog_api_password }}"
        body_format: json
        body: "{{ graylog_input_item }}"
        headers:
          Content-Type: "application/json"
          X-Requested-By: "ansible"
        status_code: 201
      loop: "{{ graylog_inputs }}"
      loop_control:
        loop_var: graylog_input_item
      register: graylog_input_create
      when: >
        ((graylog_existing_inputs.json.inputs | default([]))
          | selectattr('type','equalto', graylog_input_item.type)
          | selectattr('attributes.port','equalto', graylog_input_item.configuration.port)
          | selectattr('attributes.bind_address','equalto', (graylog_input_item.configuration.bind_address | default('0.0.0.0')))
          | list) | length == 0
      no_log: true
